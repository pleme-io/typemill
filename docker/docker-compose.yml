version: '3.8'

services:
  codebuddy:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      target: development
    container_name: codebuddy-dev
    working_dir: /app/rust
    ports:
      - "3000:3000"  # WebSocket server
      - "4000:4000"  # Admin/health endpoints
    environment:
      - RUST_LOG=debug
      - CODEBUDDY__SERVER__PORT=3000
      - CODEBUDDY__SERVER__HOST=0.0.0.0
      - CODEBUDDY__LOGGING__LEVEL=debug
      - CODEBUDDY__LOGGING__FORMAT=pretty
    volumes:
      # Mount host source code for hot-reloading
      - ../rust:/app/rust
      # Mount local cargo registry to cache dependencies
      - cargo-registry:/usr/local/cargo/registry
      # Mount target directory to cache builds
      - rust-target:/app/rust/target
    restart: unless-stopped
    networks:
      - codebuddy-net

  python-workspace:
    image: python:3.11-slim
    container_name: python-workspace
    depends_on:
      codebuddy:
        condition: service_started
    networks:
      - codebuddy-net
    command: >
      bash -c "
        pip install curl-cffi &&
        echo 'Waiting for CodeBuddy admin server...' &&
        until curl -s --fail http://codebuddy-dev:4000/health > /dev/null; do
          sleep 1;
        done;
        echo 'CodeBuddy is healthy. Registering workspace...' &&
        curl -X POST http://codebuddy-dev:4000/workspaces/register \
          -H 'Content-Type: application/json' \
          -d '{\"id\": \"python-workspace\", \"language\": \"python\", \"project_name\": \"Sample Python Project\"}' &&
        echo 'Workspace registered. Idling...' &&
        tail -f /dev/null
      "

volumes:
  cargo-registry:
  rust-target:

networks:
  codebuddy-net:
    driver: bridge
