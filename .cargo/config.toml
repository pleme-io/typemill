# =============================================================================
# Cargo Build Configuration for CodeBuddy
# =============================================================================
# This file configures build optimizations that apply to all team members
# See scripts/setup-dev-tools.sh for installation of required tools

# =============================================================================
# Compilation Caching with sccache
# =============================================================================
# sccache caches compiled artifacts to speed up rebuilds
# Installation: cargo install sccache

[build]
# sccache is configured via RUSTC_WRAPPER environment variable in Makefile
# This allows it to work without hardcoding paths
# Team members: run `make setup` to install sccache
# rustc-wrapper = "sccache"

# =============================================================================
# Fast Linker Configuration (mold)
# =============================================================================
# mold is a modern, fast linker that significantly speeds up linking
# Installation: sudo apt-get install mold (Linux) or brew install mold (macOS)

[target.x86_64-unknown-linux-gnu]
linker = "clang"
# rustflags = ["-C", "link-arg=-fuse-ld=mold"]

[target.aarch64-unknown-linux-gnu]
linker = "/usr/bin/clang"
rustflags = ["-C", "link-arg=-fuse-ld=/usr/bin/mold"]

[target.x86_64-apple-darwin]
rustflags = ["-C", "link-arg=-fuse-ld=/opt/homebrew/opt/mold/libexec/mold"]

[target.aarch64-apple-darwin]
rustflags = ["-C", "link-arg=-fuse-ld=/opt/homebrew/opt/mold/libexec/mold"]

# =============================================================================
# Development Profile Optimizations
# =============================================================================

[profile.dev]
# Enable incremental compilation
incremental = true
codegen-units = 256  # More parallelism for faster dev builds (default: 16)
split-debuginfo = "unpacked"  # Faster debug info generation on Unix

# Optimize dependencies for better runtime performance during development
# while keeping our code unoptimized for fast compile times
[profile.dev.package."*"]
opt-level = 2

# =============================================================================
# Release Profile Optimizations
# =============================================================================

[profile.release]
opt-level = 3
lto = "thin"        # Thin LTO for good optimization without excessive build time
codegen-units = 1   # Better optimization, slower compile
strip = true        # Strip symbols to reduce binary size

# =============================================================================
# Environment Configuration
# =============================================================================

[env]
# Ensure ~/.local/bin is in PATH for language servers (typescript-language-server, rust-analyzer, etc.)
# This is needed for tests that require LSP servers installed via pipx/go install
# Also ensure ~/.cargo/bin and other standard paths are included
PATH = { value = "$HOME/.local/bin:$HOME/.cargo/bin:/usr/bin:$PATH", force = true, relative = false }
# Set CC for dependencies that need a C compiler
CC = "/usr/bin/gcc"

# =============================================================================
# Sparse Registry Protocol for Faster Dependency Resolution
# =============================================================================
# Uses the modern sparse index protocol instead of the legacy git-based index
# See: https://rust-lang.github.io/rfcs/2789-sparse-index.html

[registries.crates-io]
protocol = "sparse"

# =============================================================================
# Cargo Command Aliases for Focused Development
# =============================================================================
# These aliases let you work on specific subsystems without building the entire workspace
# Usage: cargo check-analysis, cargo test-handlers-core, etc.

[alias]
# Analysis subsystem - check only analysis crates
check-analysis = "check -p cb-analysis-common -p cb-analysis-dead-code -p cb-analysis-deep-dead-code -p cb-analysis-graph -p cb-analysis-circular-deps"
test-analysis = "nextest run -p cb-analysis-common -p cb-analysis-dead-code -p cb-analysis-deep-dead-code -p cb-analysis-graph -p cb-analysis-circular-deps"

# Handlers - minimal feature set for faster iteration
check-handlers-core = "check -p cb-handlers --no-default-features --features lang-rust"
test-handlers-core = "nextest run -p cb-handlers --no-default-features --features lang-rust"

# Handlers - TypeScript only
check-handlers-ts = "check -p cb-handlers --no-default-features --features lang-typescript"
test-handlers-ts = "nextest run -p cb-handlers --no-default-features --features lang-typescript"

# Handlers - with specific analysis features
check-handlers-dead-code = "check -p cb-handlers --no-default-features --features lang-rust,analysis-dead-code"
test-handlers-dead-code = "nextest run -p cb-handlers --no-default-features --features lang-rust,analysis-dead-code"

# Core libraries without integration tests
check-core = "check --workspace --exclude integration-tests --exclude crates/cb-bench"
test-core = "nextest run --workspace --exclude integration-tests --exclude crates/cb-bench"

# Language plugins only
check-lang = "check -p cb-lang-common -p cb-lang-rust -p cb-lang-typescript -p cb-lang-markdown"
test-lang = "nextest run -p cb-lang-common -p cb-lang-rust -p cb-lang-typescript -p cb-lang-markdown"