# =============================================================================
# Cargo Build Configuration for TypeMill
# =============================================================================
# This file configures build optimizations that apply to all team members
# See 'make first-time-setup' to install required development tools

# =============================================================================
# Compilation Caching with sccache
# =============================================================================
# sccache caches compiled artifacts to speed up rebuilds
# Installation: cargo install sccache

[build]
# sccache is configured via RUSTC_WRAPPER environment variable in Makefile
# This allows it to work without hardcoding paths
# Team members: run `make setup` to install sccache
# rustc-wrapper = "sccache"

# =============================================================================
# Fast Linker Configuration (mold)
# =============================================================================
# mold is a modern, fast linker that significantly speeds up linking
# Installation: sudo apt-get install mold (Linux) or brew install mold (macOS)

[target.x86_64-unknown-linux-gnu]
linker = "clang"
# rustflags = ["-C", "link-arg=-fuse-ld=mold"]

[target.aarch64-unknown-linux-gnu]
linker = "/usr/bin/clang"
rustflags = ["-C", "link-arg=-fuse-ld=/usr/bin/mold"]

[target.x86_64-apple-darwin]
rustflags = ["-C", "link-arg=-fuse-ld=/opt/homebrew/opt/mold/libexec/mold"]

[target.aarch64-apple-darwin]
rustflags = ["-C", "link-arg=-fuse-ld=/opt/homebrew/opt/mold/libexec/mold"]

# =============================================================================
# Development Profile Optimizations
# =============================================================================

[profile.dev]
# Enable incremental compilation
incremental = true
codegen-units = 256  # More parallelism for faster dev builds (default: 16)
split-debuginfo = "unpacked"  # Faster debug info generation on Unix

# Optimize dependencies for better runtime performance during development
# while keeping our code unoptimized for fast compile times
[profile.dev.package."*"]
opt-level = 2

# =============================================================================
# Release Profile Optimizations
# =============================================================================

[profile.release]
opt-level = 3
lto = "thin"        # Thin LTO for good optimization without excessive build time
codegen-units = 1   # Better optimization, slower compile
strip = true        # Strip symbols to reduce binary size

# =============================================================================
# Environment Configuration
# =============================================================================

[env]
# Note: PATH configuration removed - cargo does not expand shell variables like $HOME and $PATH
# This was causing issues where test processes received literal "$HOME" strings in PATH
# Instead, rely on the shell's PATH which is already correctly configured
# Set CC for dependencies that need a C compiler
CC = "/usr/bin/gcc"

# =============================================================================
# Sparse Registry Protocol for Faster Dependency Resolution
# =============================================================================
# Uses the modern sparse index protocol instead of the legacy git-based index
# See: https://rust-lang.github.io/rfcs/2789-sparse-index.html

[registries.crates-io]
protocol = "sparse"

# =============================================================================
# Cargo Command Aliases for Focused Development
# =============================================================================
# These aliases let you work on specific subsystems without building the entire workspace
# Usage: cargo check-analysis, cargo test-handlers-core, etc.

[alias]
# Build automation
xtask = "run --package xtask --"

# Analysis subsystem - check only analysis crates
check-analysis = "check -p cb-analysis-common -p cb-analysis-dead-code -p cb-analysis-deep-dead-code -p cb-analysis-graph -p cb-analysis-circular-deps"
test-analysis = "nextest run -p cb-analysis-common -p cb-analysis-dead-code -p cb-analysis-deep-dead-code -p cb-analysis-graph -p cb-analysis-circular-deps"

# Handlers - minimal feature set for faster iteration (both languages, no analysis)
check-handlers-core = "check -p cb-handlers --no-default-features --features lang-rust,lang-typescript"
test-handlers-core = "nextest run -p cb-handlers --no-default-features --features lang-rust,lang-typescript"

# Handlers - TypeScript only
check-handlers-ts = "check -p cb-handlers --no-default-features --features lang-typescript"
test-handlers-ts = "nextest run -p cb-handlers --no-default-features --features lang-typescript"

# Handlers - with specific analysis features
check-handlers-dead-code = "check -p cb-handlers --no-default-features --features lang-rust,analysis-dead-code"
test-handlers-dead-code = "nextest run -p cb-handlers --no-default-features --features lang-rust,analysis-dead-code"

# Core libraries without integration tests
check-core = "check --workspace --exclude integration-tests --exclude cb-bench"
test-core = "nextest run --workspace --exclude integration-tests --exclude cb-bench"

# Language plugins only
check-lang = "check -p mill-lang-common -p cb-lang-rust -p mill-lang-typescript -p cb-lang-markdown"
test-lang = "nextest run -p mill-lang-common -p cb-lang-rust -p mill-lang-typescript -p cb-lang-markdown"

# Navigation/analysis only (no refactoring handlers - 15-25% faster)
check-handlers-nav = "check -p cb-handlers --no-default-features --features lang-rust,lang-typescript"
test-handlers-nav = "nextest run -p cb-handlers --no-default-features --features lang-rust,lang-typescript"

# Integration test filtering (60-80% faster for targeted tests)
test-integration-refactor = "nextest run -p integration-tests -E 'test(/(rename|extract|inline|move|reorder|transform|delete)/)'"
test-integration-analysis = "nextest run -p integration-tests -E 'test(/analyze/)'"
test-integration-nav = "nextest run -p integration-tests -E 'test(/(find|search|get_symbol|get_call)/)'"
