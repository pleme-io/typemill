# Workflows & Refactoring

Fast reference for workflow automation and refactoring operations.

## Unified Refactoring API (Recommended)

All refactoring operations follow a safe two-step pattern:

| Step | Tool | Purpose | Modifies Files? |
|------|------|---------|-----------------|
| 1. Plan | `*.plan` | Preview changes | ❌ No |
| 2. Apply | `workspace.apply_edit` | Execute changes | ✅ Yes |

### Available Refactorings

| Tool | Purpose | Required Parameters |
|------|---------|---------------------|
| `rename.plan` | Rename symbol/file/directory | `file_path`, `line`, `character`, `new_name` |
| `extract.plan` | Extract function/variable | `file_path`, `range`, `new_name` |
| `inline.plan` | Inline variable | `file_path`, `line`, `character` |
| `move.plan` | Move code between files | `kind`, `source`, `destination` |
| `reorder.plan` | Reorder parameters/imports | `kind`, `target`, `options` |
| `transform.plan` | Transform code (e.g., to async) | `kind`, `target` |
| `delete.plan` | Delete unused code | `kind`, `target` |
| `workspace.apply_edit` | Apply any plan | `edit_id` (from plan), `options` (optional) |

### Safety Features

| Feature | How It Works | Benefit |
|---------|--------------|---------|
| **Mandatory Preview** | `*.plan` always returns preview | Can't accidentally apply changes |
| **Detailed Change Preview** | Shows all files, exact changes, counts | Full visibility before commit |
| **Double Preview** | `workspace.apply_edit` supports `dry_run: true` | Final check before execution |
| **Atomic Operations** | All files updated or none | Transaction-like behavior |
| **Edit Caching** | Plans cached 5 minutes | Time for review |

### Example Usage

```json
// Step 1: Plan (preview only)
{
  "name": "rename.plan",
  "arguments": {
    "file_path": "src/api.ts",
    "line": 10,
    "character": 5,
    "new_name": "getData"
  }
}

// Response
{
  "edit_id": "550e8400-e29b-41d4-a716-446655440000",
  "changes": { "src/api.ts": [...], "src/client.ts": [...] },
  "summary": "Rename 'fetchData' to 'getData' (3 files, 12 occurrences)"
}

// Step 2: Apply
{
  "name": "workspace.apply_edit",
  "arguments": {
    "edit_id": "550e8400-e29b-41d4-a716-446655440000",
    "options": { "dry_run": false }
  }
}
```

## Legacy Intent-Based Workflows

**Note:** For refactoring, use Unified API above. Legacy workflows maintained for non-refactoring operations (docs generation, research).

### Core Concepts

| Concept | Description | Example |
|---------|-------------|---------|
| **Intent** | High-level goal | `"research.topic"` |
| **Workflow** | Executable plan | Generated by Planner |
| **Step** | Atomic action | Single tool call |

### Using achieve_intent Tool

| Mode | Parameters | Purpose |
|------|------------|---------|
| **Plan Only** | `intent` only | Preview workflow steps |
| **Execute** | `intent` + `execute: true` | Run workflow |
| **Dry Run** | `intent` + `execute: true` + `dry_run: true` | Preview changes without modifying files |
| **Resume** | `workflow_id` | Continue paused workflow |

### Parameter Templating

| Type | Syntax | Purpose | Example |
|------|--------|---------|---------|
| **Intent params** | `{param_name}` | Substitute from intent | `"{file_path}"` → `"src/api.ts"` |
| **Step results** | `$steps.{index}.{path}` | Use previous step output | `"$steps.0.symbols.0.line"` → `15` |

### Available Intents

#### Refactoring (Deprecated)

| Intent | Status | Use Instead |
|--------|--------|-------------|
| `refactor.renameSymbol` | ❌ Deprecated | `rename.plan` + `workspace.apply_edit` |
| `refactor.extractFunction` | ❌ Deprecated | `extract.plan` + `workspace.apply_edit` |

#### Non-Refactoring (Active)

| Intent | Purpose | Parameters | Steps |
|--------|---------|------------|-------|
| `docs.generateDocstring` | Generate function docs | `file_path`, `symbol_name` | 3 |
| `research.topic` | Web research | `topic` | 2 |

### Workflow Execution Flow

| Phase | Action | Details |
|-------|--------|---------|
| **Planning** | Lookup template | From `workflows.json` |
| | Replace placeholders | `{param}` → values |
| | Validate | Check required params |
| **Execution** | Process steps | Sequential |
| | Check confirmation | Pause if required |
| | Resolve placeholders | `$steps` from results |
| | Execute tool | Via PluginManager |
| | Store result | For future steps |
| **Completion** | Return log | With statistics |

### Error Handling

| Error Type | When | Response |
|------------|------|----------|
| Planning | Missing params, unknown intent | Error with details |
| Execution | Tool failure | Halt with error, preserve logs |
| Validation | Invalid placeholders | Error before execution |

### Interactive Workflows

| Feature | Purpose | Details |
|---------|---------|---------|
| **Confirmation Pause** | Review before destructive ops | `requires_confirmation: true` |
| **Resume** | Continue after approval | Via `workflow_id` |
| **State Preservation** | Maintain context | Logs + step results cached |

### Configuration

| File | Purpose | Allows |
|------|---------|--------|
| `.codebuddy/workflows.json` | Workflow templates | Custom workflows, modify existing, project-specific patterns |

## Best Practices

### For Refactoring

| Practice | Rationale |
|----------|-----------|
| Use Unified API | Simpler, safer than legacy workflows |
| Always preview first | Call `*.plan` before applying |
| Review changes carefully | Examine detailed preview |
| Use dry run for final check | Extra safety layer |
| Leverage atomic operations | All succeed or none applied |

### For Legacy Workflows

| Practice | Rationale |
|----------|-----------|
| Start with planning | Preview before executing |
| Use dry-run | Test destructive workflows |
| Review confirmations | Carefully check paused workflows |
| Check logs | Detailed step information |
| Migrate to Unified API | For all refactoring operations |

## Migration Guide

### From Legacy to Unified API

| Old (Legacy) | New (Unified API) |
|--------------|-------------------|
| `refactor.renameSymbol` intent | `rename.plan` + `workspace.apply_edit` |
| `refactor.extractFunction` intent | `extract.plan` + `workspace.apply_edit` |
| Single tool call | Two-step: plan → apply |
| Optional preview | Mandatory preview |

**Benefits of migration:**
- Mandatory preview (can't accidentally apply)
- Clearer two-step pattern
- Better error handling
- Consistent across all refactorings

## Advanced Features

| Feature | Purpose | Details |
|---------|---------|---------|
| **State Management** | Access previous results | `HashMap<usize, Value>`, `$steps.{index}` |
| **Dry-Run Mode** | Preview changes | No file modifications |
| **Workflow Metadata** | Estimate scope | Complexity score = number of steps |
| **Interactive Workflows** | User approval | Pause/resume with UUID |

## Future Enhancements

| Feature | Status | Description |
|---------|--------|-------------|
| User input collection | Planned | Collect data during execution via `resume_data` |
| Conditional steps | Planned | Execute based on previous results |
| Parallel execution | Planned | Independent steps run concurrently |
| Workflow composition | Planned | Call workflows from workflows |
| Custom validators | Planned | Validate step outputs |

## Key References

- [API_REFERENCE.md](API_REFERENCE.md) - Complete tool API
- [TOOLS_CATALOG.md](TOOLS_CATALOG.md) - Tool lookup table
- [OPERATIONS.md](OPERATIONS.md) - Advanced configuration
- [docs/archive/workflows-verbose.md](archive/workflows-verbose.md) - Full guide with examples
